# Technical Refactoring Plan: App.tsx

**Version:** 1.0
**Date:** 2025-09-09
**Status:** Proposed

---

## 1. Overview & Strategy

This document outlines a detailed technical plan to refactor the `App.tsx` component. The current component has grown to an unmaintainable size, managing state and logic for almost every feature in the application. This violates the Single Responsibility Principle and makes debugging and further development slow and error-prone.

The core strategy is to **extract logical domains into dedicated custom hooks**. This will transform `App.tsx` into a lean orchestrator component that composes these hooks, manages top-level state, and renders the main application layout. The refactoring will be performed iteratively, one hook at a time, with type-checking verification at each step.

---

## 2. Refactoring Domain: Persona Management

*   **WHAT:** All state and callback functions related to Persona management will be refactored. This includes the logic for creating, saving, updating, deleting, and auto-generating personas, as well as the UI state for the persona generation modal.
*   **WHY:** To extract complex, feature-specific business logic from the main `App` component. This improves separation of concerns, significantly reduces the line count and complexity of `App.tsx`, and makes the persona logic itself easier to understand, test, and debug in isolation.
*   **WHO:** The AI Assistant will perform this refactoring.
*   **WHERE:** The logic will be moved from `App.tsx` to a new, dedicated custom hook at `src/hooks/usePersonaManagement.ts`.
*   **WHEN:** This will be the first feature domain to be extracted in the sequential refactoring process, immediately following your approval of this plan.
*   **HOW:**
    1.  **Hook Creation:** A new file, `usePersonaManagement.ts`, will be created in the `src/hooks/` directory.
    2.  **Hook Signature (Interface):** The hook will be defined with a signature to accept its dependencies from the `App` component (e.g., `dispatch`, `mongoBrandId`, `settings`, `setError`).
    3.  **State Migration:** The `isAutoPersonasModalOpen` and `autoGeneratedPersonas` `useState` declarations will be moved from `App.tsx` into the hook.
    4.  **Logic Migration:** The `handleSavePersona`, `handleUpdatePersona`, `handleDeletePersona`, `handleAutoGeneratePersona`, `handleSaveSelectedPersonas`, and `handleSetPersonaImage` `useCallback` functions will be moved from `App.tsx` into the hook, preserving their dependency arrays.
    5.  **Return Value:** The hook will return a stable object containing the state and memoized handlers it now manages (e.g., `{ isAutoPersonasModalOpen, autoGeneratedPersonas, handleSavePersona, ... }`).
    6.  **`App.tsx` Integration:** The original state and callback definitions will be deleted from `App.tsx` and replaced with a single hook instantiation: `const personaManager = usePersonaManagement(dependencies...)`.
    7.  **Prop Updates:** Props passed to child components like `MainDisplay` and `AutoPersonaResultModal` will be updated to reference the new `personaManager` object (e.g., `onSavePersona={personaManager.handleSavePersona}`).
    8.  **Verification:** The command `npx tsc --noEmit` will be executed to ensure the refactoring is type-safe.

---

## 3. Refactoring Domain: Media Plan & Content Generation

*   **WHAT:** All logic related to creating media plans, including from the wizard, from a content package, and from a funnel campaign.
*   **WHY:** This logic is core to the application but is highly complex, involving prompt construction, orchestration of AI service calls, and processing of results. Co-locating this logic in its own module is essential for clarity and future improvements.
*   **WHO:** The AI Assistant.
*   **WHERE:** From `App.tsx` to a new hook at `src/hooks/useMediaPlanManagement.ts`.
*   **WHEN:** After the Persona Management hook is successfully integrated.
*   **HOW:**
    1.  **Hook Creation:** A new file `useMediaPlanManagement.ts` will be created.
    2.  **Hook Signature:** The hook will accept dependencies, including the `generatedAssets` state (to access `brandFoundation`), `settings`, `aiModelConfig`, `ensureMongoProject`, and the `dispatch` function.
    3.  **Logic Migration:** The `handleGenerateMediaPlanGroup`, `handleCreateFunnelCampaignPlan`, and `handleGenerateContentPackage` `useCallback` functions will be moved into the hook.
    4.  **Return Value:** The hook will return an object containing the handlers: `{ handleGenerateMediaPlanGroup, handleCreateFunnelCampaignPlan, handleGenerateContentPackage }`.
    5.  **`App.tsx` Integration:** The original callbacks will be removed and replaced by destructuring the returned object from the `useMediaPlanManagement()` hook call. Props passed to `MainDisplay` will be updated.
    6.  **Verification:** The build will be checked with `npx tsc --noEmit`.

---

## 4. Refactoring Domain: Asset & Media Handling

*   **WHAT:** The logic for handling image and video assets, including AI generation, uploading, and local state management.
*   **WHY:** Asset handling involves interaction with client-side file APIs, Cloudinary uploads, and state updates for both the main asset list and the local `generatedImages` cache. This self-contained logic is a perfect candidate for extraction.
*   **WHO:** The AI Assistant.
*   **WHERE:** From `App.tsx` to a new hook at `src/hooks/useAssetManagement.ts`.
*   **WHEN:** After the Media Plan hook is successfully integrated.
*   **HOW:**
    1.  **Hook Creation:** A new file `useAssetManagement.ts` will be created.
    2.  **Hook Signature:** The hook will accept dependencies such as `mongoBrandId`, `generatedAssets`, `dispatchAssets`, `setGeneratedImages`, `setGeneratedVideos`, and `updateAutoSaveStatus`.
    3.  **Logic Migration:** The `handleGenerateImage`, `handleSetImage`, `handleSetVideo`, and the internal helper `generateSingleImageCore` `useCallback` functions will be moved into the hook.
    4.  **Return Value:** The hook will return the handler functions: `{ handleGenerateImage, handleSetImage, handleSetVideo }`.
    5.  **`App.tsx` Integration:** The original callbacks will be removed and replaced by the call to the `useAssetManagement()` hook. Props passed to `MainDisplay` will be updated.
    6.  **Verification:** The build will be checked with `npx tsc --noEmit`.

---

## 5. Refactoring Domain: Affiliate & Strategy Hub

*   **WHAT:** All logic for managing the Affiliate Vault and the Strategy Hub. This includes loading data for both tabs, creating/deleting trends and affiliate links, and generating ideas from trends or products.
*   **WHY:** These two domains are closely related (generating ideas from affiliate products creates a trend) and represent a significant chunk of business logic focused on top-of-funnel content strategy. Extracting them clarifies the purpose of `App.tsx` and simplifies the data flow for strategic planning.
*   **WHO:** The AI Assistant.
*   **WHERE:** From `App.tsx` to a new hook at `src/hooks/useStrategyManagement.ts`.
*   **WHEN:** After the Asset Management hook is successfully integrated.
*   **HOW:**
    1.  **Hook Creation:** A new file `useStrategyManagement.ts` will be created.
    2.  **Hook Signature:** It will accept dependencies like `mongoBrandId`, `dispatchAssets`, `updateAutoSaveStatus`, `setError`, `setLoaderContent`, `settings`, `aiModelConfig`, etc.
    3.  **Logic Migration:** The following `useCallback` functions will be moved into the hook: `handleLoadStrategyHubData`, `handleLoadAffiliateVaultData`, `handleSaveTrend`, `handleDeleteTrend`, `handleGenerateIdeas`, `handleGenerateIdeasFromProduct`, `handleSaveAffiliateLink`, `handleDeleteAffiliateLink`, `handleImportAffiliateLinks`, and `handleReloadAffiliateLinks`.
    4.  **Return Value:** The hook will return an object containing all the migrated handler functions.
    5.  **`App.tsx` Integration:** The original callbacks will be removed and replaced by the call to the `useStrategyManagement()` hook. Props passed to `MainDisplay` will be updated.
    6.  **Verification:** The build will be checked with `npx tsc --noEmit`.

---

## 6. Refactoring Domain: Scheduling & Publishing

*   **WHAT:** All logic related to scheduling, bulk-scheduling, and direct publishing of posts.
*   **WHY:** Post scheduling and publishing is a distinct, critical workflow that involves its own UI state (modals) and complex logic for calculating dates and interacting with social APIs. Separating it makes the core `App.tsx` cleaner.
*   **WHO:** The AI Assistant.
*   **WHERE:** From `App.tsx` to a new hook at `src/hooks/useSchedulingManagement.ts`.
*   **WHEN:** After the Strategy Management hook is successfully integrated.
*   **HOW:**
    1.  **Hook Creation:** A new file `useSchedulingManagement.ts` will be created.
    2.  **Hook Signature:** It will accept dependencies like `generatedAssets`, `mongoBrandId`, `dispatchAssets`, `updateAutoSaveStatus`, `setError`, etc.
    3.  **State Migration:** The following `useState` calls will be moved into the hook: `selectedPostIds`, `schedulingPost`, `isBulkScheduleModalOpen`, and `isScheduling`.
    4.  **Logic Migration:** The following `useCallback` functions will be moved into the hook: `handleTogglePostSelection`, `handleSelectAllPosts`, `handleSchedulePost`, `handlePublishPost`, `handlePostDrop`, and `handleBulkSchedule`.
    5.  **Return Value:** The hook will return an object containing the state and handlers.
    6.  **`App.tsx` Integration:** The original state and callbacks will be removed and replaced by the call to the `useSchedulingManagement()` hook. Props passed to `MainDisplay` and modals will be updated.
    7.  **Verification:** The build will be checked with `npx tsc --noEmit`.

---

## 7. Refactoring Domain: Project Input/Output (I/O)

*   **WHAT:** All logic related to loading a project from a file or database, and saving a project to a file.
*   **WHY:** This logic deals with file system APIs, data serialization/deserialization, and the initial hydration of the application state. It's a clear, separable concern.
*   **WHO:** The AI Assistant.
*   **WHERE:** From `App.tsx` to a new hook at `src/hooks/useProjectIO.ts`.
*   **WHEN:** This will be one of the final domains to be extracted.
*   **HOW:**
    1.  **Hook Creation:** A new file `useProjectIO.ts` will be created.
    2.  **Hook Signature:** It will accept dependencies like `dispatchAssets`, `setSettings`, `setGeneratedImages`, `setMongoBrandId`, `setCurrentStep`, `setActiveTab`, etc.
    3.  **Logic Migration:** The `handleSaveProjectToFile`, `handleLoadProjectFile`, and `handleLoadFromDatabase` `useCallback` functions will be moved into the hook.
    4.  **Return Value:** The hook will return the handler functions: `{ handleSaveProjectToFile, handleLoadProjectFile, handleLoadFromDatabase }`.
    5.  **`App.tsx` Integration:** The original callbacks will be removed and replaced by the call to the `useProjectIO()` hook. Props passed to `IdeaProfiler` and `MainDisplay` will be updated.
    6.  **Verification:** The build will be checked with `npx tsc --noEmit`.

---

*This iterative process will be repeated for all other logical domains until `App.tsx` is fully refactored.*